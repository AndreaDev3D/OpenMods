@using OpenMods.Server.Models
@inject NavigationManager NavigationManager

<div class="group relative flex flex-col md:flex-row items-center gap-6 p-5 bg-card-dark border border-border-dark rounded-2xl hover:border-primary/50 transition-all duration-300 cursor-pointer"
     @onclick="NavigateToDetails">
    <!-- Thumbnail -->
    <div
        class="relative w-full md:w-36 h-36 shrink-0 rounded-xl overflow-hidden bg-slate-900 flex items-center justify-center">
        @if (!string.IsNullOrEmpty(Mod.ImageUrl))
        {
            <img src="@Mod.ImageUrl"
                 class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                 alt="@Mod.Name" />
        }
        else
        {
            <span class="material-symbols-outlined text-4xl text-slate-700">deployed_code</span>
        }
    </div>

    <!-- Content -->
    <div class="flex-1 min-w-0 py-1">
        <div class="flex flex-wrap items-center gap-2 mb-2">
            <h3 class="text-xl font-bold text-white group-hover:text-primary transition-colors truncate">@Mod.Name</h3>
            @if (Mod.Stars > 1000)
            {
                <span
                class="bg-emerald-500/10 text-emerald-500 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">Verified</span>
            }
            @foreach (var cat in Mod.Categories.Take(1))
            {
                <span
                class="bg-slate-700/50 text-slate-400 text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">@cat.Name</span>
            }
            @foreach (var game in Mod.Releases.OrderByDescending(r => r.ReleasedAt).FirstOrDefault()?.SupportedGames ?? new())
            {
                <span
                class="bg-primary/10 text-primary text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider border border-primary/20">@game.Name</span>
            }
        </div>

        <div class="flex items-center gap-3 text-xs text-slate-400 mb-4 font-mono">
            <div class="flex items-center gap-1.5 hover:text-white transition-colors">
                <div class="size-4 rounded-full bg-cover" style="background-image: url('@Mod.Developer?.AvatarUrl')">
                </div>
                <span>@Mod.Developer?.GitHubUsername / @Mod.Name.ToLower().Replace(" ", "-")</span>
            </div>
            <span class="text-slate-600">â€¢</span>
            <div class="flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-yellow-500/80">star</span>
                <span class="font-bold">@FormatCount(Mod.Stars)</span>
            </div>
        </div>

        <p class="text-sm text-slate-400 line-clamp-2 mb-4 leading-relaxed max-w-2xl">
            @Mod.Description
        </p>

        <div class="flex items-center gap-4 text-[11px] font-bold uppercase tracking-widest text-slate-500">
            <span>Latest: <span class="text-white">@LatestVersion</span></span>
            <span class="text-slate-700">|</span>
            <span>Updated: <span class="text-white">@TimeAgo(Mod.UpdatedAt)</span></span>
        </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-row md:flex-col gap-2 w-full md:w-auto shrink-0">
        <button
            class="flex-1 md:w-32 h-10 bg-primary text-white text-xs font-bold rounded-lg flex items-center justify-center gap-2 hover:brightness-110 shadow-lg shadow-primary/20 transition-all">
            <span class="material-symbols-outlined text-sm">download</span>
            Download
        </button>
        <a href="@Mod.GitHubRepoUrl" target="_blank"
               class="flex-1 md:w-32 h-10 bg-slate-800 text-slate-300 text-xs font-bold rounded-lg flex items-center justify-center gap-2 hover:bg-slate-700 transition-colors"
               @onclick:stopPropagation="true">
            <span class="material-symbols-outlined text-sm">code</span>
            GitHub
        </a>
    </div>
</div>

@code {
    [Parameter] public Mod Mod { get; set; } = new();

    private string LatestVersion => Mod.Releases.MaxBy(r => r.ReleasedAt)?.Version ?? "v0.0.0-STABLE";

    private string FormatCount(int count) => count >= 1000 ? $"{(count / 1000.0):F1}k" : count.ToString();

    private string TimeAgo(DateTime dateTime)
    {
        var span = DateTime.UtcNow - dateTime.ToUniversalTime();
        if (span.TotalDays > 1) return $"{(int)span.TotalDays}d ago";
        if (span.TotalHours > 1) return $"{(int)span.TotalHours}h ago";
        return "NOW";
    }

    private void NavigateToDetails()
    {
        NavigationManager.NavigateTo($"mod/{Mod.Id}");
    }
}
