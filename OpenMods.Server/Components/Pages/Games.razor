@page "/games"
@using Microsoft.EntityFrameworkCore
@using OpenMods.Shared.Data
@using OpenMods.Shared.Models
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav

<PageTitle>Games Directory | OpenMods</PageTitle>

<div class="min-h-screen text-[#e1e7ef] font-display pb-20">
    <!-- Hero Section -->
    <div class="pt-24 pb-16 text-center px-4 max-w-4xl mx-auto">
        <h1 class="text-5xl font-extrabold tracking-tight mb-4 bg-clip-text text-transparent bg-gradient-to-b from-white to-white/60">
            Games Directory
        </h1>
        <p class="text-xl text-[#92a4c9] leading-relaxed max-w-2xl mx-auto">
            Browse the official ecosystem of games supported by OpenMods' decentralized distribution protocol.
        </p>
    </div>

    <!-- Search Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
        <div class="relative group max-w-2xl mx-auto">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <span class="material-symbols-outlined text-[#92a4c9] group-focus-within:text-primary transition-colors">search</span>
            </div>
            <input type="text" 
                   @bind="_searchQuery" 
                   @bind:event="oninput"
                   placeholder="Find a game (e.g. Starfield, Cyberpunk, Minecraft)..." 
                   class="w-full bg-[#12141c] border border-[#232a3b] rounded-xl py-4 pl-12 pr-16 text-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all placeholder:text-[#4a5568]" />
            <div class="absolute inset-y-0 right-0 pr-4 flex items-center">
                <div class="bg-[#1a1e2b] border border-[#232a3b] rounded-md px-1.5 py-0.5 text-[10px] font-bold text-[#4a5568] tracking-widest">
                    ESC
                </div>
            </div>
        </div>
    </div>

    <!-- Games Grid -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        @if (_filteredGames == null)
        {
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
                @for (int i = 0; i < 10; i++)
                {
                    <div class="aspect-[3/4] rounded-2xl bg-[#12141c] animate-pulse border border-[#232a3b]"></div>
                }
            </div>
        }
        else if (!_filteredGames.Any())
        {
            <div class="py-20 text-center">
                <div class="size-20 bg-[#12141c] border border-[#232a3b] rounded-full flex items-center justify-center mx-auto mb-6 text-[#4a5568]">
                    <span class="material-symbols-outlined text-4xl">search_off</span>
                </div>
                <h3 class="text-2xl font-bold mb-2">No games found</h3>
                <p class="text-[#92a4c9]">We couldn't find any games matching your search terms.</p>
            </div>
        }
        else
        {
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
                @foreach (var game in _filteredGames)
                {
                    <div class="group relative aspect-[3/4] rounded-2xl overflow-hidden border border-[#232a3b] hover:border-primary/50 transition-all cursor-pointer"
                         @onclick='() => Nav.NavigateTo($"/explore?gameId={game.Id}")'>
                        <!-- Background Image -->
                        <div class="absolute inset-0 bg-cover bg-center transition-transform duration-500 group-hover:scale-110" 
                             style="background-image: url('@game.ImageUrl')">
                        </div>
                        
                        <!-- Gradients -->
                        <div class="absolute inset-0 bg-gradient-to-t from-[#0a0c10] via-transparent to-black/20"></div>
                        <div class="absolute inset-0 bg-black/40 group-hover:bg-black/20 transition-colors"></div>

                        <!-- Content -->
                        <div class="absolute inset-0 p-6 flex flex-col justify-end">
                            <h3 class="text-xl font-bold text-white mb-2 leading-tight">@game.Name</h3>
                            <div class="flex items-center">
                                <span class="bg-primary/20 text-primary px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wider border border-primary/30">
                                    @FormatCount(_gameModCounts.GetValueOrDefault(game.Id, 0)) Mods
                                </span>
                            </div>
                        </div>
                        
                        <!-- Hover Overlay -->
                        <div class="absolute inset-0 bg-primary/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Missing Game Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-24">
        <div class="bg-[#12141c]/50 rounded-3xl border border-dashed border-[#232a3b] p-16 text-center relative overflow-hidden">
            <div class="absolute -top-12 -left-12 size-48 bg-primary/5 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-12 -right-12 size-48 bg-primary/5 rounded-full blur-3xl"></div>

            <div class="size-12 bg-primary/20 border border-primary/30 rounded-full flex items-center justify-center mx-auto mb-8 text-primary shadow-lg shadow-primary/20">
                <span class="material-symbols-outlined text-2xl">add</span>
            </div>

            <h3 class="text-3xl font-bold mb-4">Missing a game?</h3>
            <p class="text-lg text-[#92a4c9] max-w-xl mx-auto mb-10 leading-relaxed">
                Can't find your favorite title? Help us expand the OpenMods ecosystem by requesting new integrations via GitHub.
            </p>

            <button class="bg-primary hover:bg-primary/90 text-white font-bold py-4 px-10 rounded-xl transition-all shadow-lg shadow-primary/30 flex items-center gap-2 mx-auto">
                <span class="material-symbols-outlined text-xl">chat</span>
                Ask for a new game
            </button>
        </div>
    </div>
</div>

@code {
    private List<Game>? _games;
    private Dictionary<int, int> _gameModCounts = new();
    private string _searchQuery = "";

    private List<Game>? _filteredGames => string.IsNullOrWhiteSpace(_searchQuery) 
        ? _games 
        : _games?.Where(g => g.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();
        _games = await context.Games
            .Include(g => g.Mods)
            .ToListAsync();

        foreach (var game in _games)
        {
            _gameModCounts[game.Id] = game.Mods.Count;
        }
    }

    private string FormatCount(int count)
    {
        if (count >= 1000) return $"{(count / 1000.0):F1}k";
        return count.ToString();
    }
}
