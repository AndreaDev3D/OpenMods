@page "/dashboard/analytics"
@layout OpenMods.Server.Components.Layout.DashboardLayout
@using OpenMods.Shared.Models
@using OpenMods.Shared.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@inject AnalyticsService AnalyticsService
@inject ApiKeyService ApiKeyService
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="bg-[#0a0f1d] min-h-full text-slate-100 font-display">
<header class="sticky top-0 z-10 bg-[#0a0f1d]/80 backdrop-blur-md border-b border-slate-700/50 px-8 py-4 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold tracking-tight">Analytics Dashboard</h1>
        <p class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mt-1">Real-time performance metrics</p>
    </div>
    <div class="flex items-center gap-4">
         <div class="bg-[#1a2133] border border-slate-700/50 p-1 rounded-lg flex items-center">
            <button class="px-4 py-1.5 text-[10px] font-bold rounded bg-primary/20 text-primary">Last 30 Days</button>
            <button class="px-4 py-1.5 text-[10px] font-bold text-slate-500 hover:text-slate-300 transition-colors">Last 12 Months</button>
        </div>
        <button class="p-2 text-slate-400 hover:text-white relative transition-colors">
            <span class="material-symbols-outlined text-2xl">notifications</span>
            <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-[#0a0f1d]"></span>
        </button>
    </div>
</header>

<div class="p-8 space-y-8">

    @if (_summary == null)
    {
        <div class="flex justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        </div>
    }
    else
    {
        <!-- Metrics Overlap -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-[#131a2b] p-6 rounded-2xl border border-slate-700/30 shadow-xl overflow-hidden relative">
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Downloads</p>
                        <span class="bg-emerald-500/10 text-emerald-500 px-2.5 py-1 rounded-full text-[10px] font-bold flex items-center gap-1">
                            <span class="material-symbols-outlined text-[10px]">trending_up</span> 12%
                        </span>
                    </div>
                    <h3 class="text-4xl font-bold mb-6">@_summary.TotalDownloads.ToString("N0")</h3>
                    
                    <!-- Sparkline (SVG) -->
                    <div class="h-12 w-full flex items-end gap-1 px-1">
                        @for (int i = 0; i < 8; i++)
                        {
                            <div class="flex-1 bg-primary/20 rounded-sm" style="height: @(Random.Shared.Next(30, 100))%;"></div>
                        }
                        <div class="flex-1 bg-primary rounded-sm shadow-[0_0_15px_rgba(59,130,246,0.5)]" style="height: 100%;"></div>
                        @for (int i = 0; i < 4; i++)
                        {
                            <div class="flex-1 bg-primary/20 rounded-sm" style="height: @(Random.Shared.Next(40, 90))%;"></div>
                        }
                    </div>
                </div>
            </div>

            <div class="bg-[#131a2b] p-6 rounded-2xl border border-slate-700/30 shadow-xl overflow-hidden relative">
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Page Views</p>
                        <span class="bg-emerald-500/10 text-emerald-500 px-2.5 py-1 rounded-full text-[10px] font-bold flex items-center gap-1">
                            <span class="material-symbols-outlined text-[10px]">trending_up</span> 8.4%
                        </span>
                    </div>
                    <h3 class="text-4xl font-bold mb-6">@_summary.TotalPageViews.ToString("N0")</h3>
                    
                    <div class="h-12 w-full flex items-end gap-1 px-1">
                         @for (int i = 0; i < 10; i++)
                        {
                            <div class="flex-1 bg-slate-700/30 rounded-sm" style="height: @(Random.Shared.Next(20, 80))%;"></div>
                        }
                        <div class="flex-1 bg-slate-300 rounded-sm shadow-[0_0_10px_rgba(255,255,255,0.2)]" style="height: 100%;"></div>
                        @for (int i = 0; i < 2; i++)
                        {
                            <div class="flex-1 bg-slate-700/30 rounded-sm" style="height: @(Random.Shared.Next(40, 60))%;"></div>
                        }
                    </div>
                </div>
            </div>

            <div class="bg-[#131a2b] p-6 rounded-2xl border border-slate-700/30 shadow-xl overflow-hidden relative">
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Unique Users</p>
                        <span class="bg-rose-500/10 text-rose-500 px-2.5 py-1 rounded-full text-[10px] font-bold flex items-center gap-1">
                            <span class="material-symbols-outlined text-[10px]">trending_down</span> 3.2%
                        </span>
                    </div>
                    <h3 class="text-4xl font-bold mb-6">@_summary.UniqueUsers.ToString("N0")</h3>
                    
                    <div class="h-12 w-full flex items-end gap-1 px-1">
                         @for (int i = 0; i < 11; i++)
                        {
                            <div class="flex-1 bg-indigo-500/20 rounded-sm" style="height: @(Random.Shared.Next(30, 70))%;"></div>
                        }
                        <div class="flex-1 bg-indigo-500 rounded-sm shadow-[0_0_15px_rgba(99,102,241,0.5)]" style="height: 100%;"></div>
                        @for (int i = 0; i < 1; i++)
                        {
                            <div class="flex-1 bg-indigo-500/20 rounded-sm" style="height: @(Random.Shared.Next(50, 70))%;"></div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Main Chart Area -->
            <div class="lg:col-span-3 bg-[#131a2b] p-8 rounded-2xl border border-slate-700/30 shadow-xl">
                <div class="flex items-center justify-between mb-12">
                     <div>
                        <h4 class="font-bold text-lg">Downloads vs. Views</h4>
                        <p class="text-sm text-slate-500">Activity comparison</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-primary"></div>
                            <span class="text-xs font-bold text-slate-400">Downloads</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-slate-500"></div>
                            <span class="text-xs font-bold text-slate-400">Views</span>
                        </div>
                    </div>
                </div>

                <!-- Custom Chart Container -->
                <div class="relative h-64 w-full flex items-end justify-between border-b border-slate-700/50 pb-2">
                    <!-- Y-Axis Lines -->
                    <div class="absolute inset-0 flex flex-col justify-between -z-0">
                        <div class="w-full border-t border-slate-800/50"></div>
                        <div class="w-full border-t border-slate-800/50"></div>
                        <div class="w-full border-t border-slate-800/50"></div>
                    </div>

                    @foreach (var metric in _chartMetrics)
                    {
                        <div class="flex-1 flex flex-col items-center justify-end px-1 gap-1">
                            <div class="w-full flex justify-center gap-0.5 items-end h-full">
                                <div class="w-4 bg-slate-500/40 rounded-t-sm" style="height: @(metric.ViewsHeight)%;"></div>
                                <div class="w-4 bg-primary rounded-t-sm shadow-[0_0_10px_rgba(59,130,246,0.3)]" style="height: @(metric.DownloadsHeight)%;"></div>
                            </div>
                        </div>
                    }
                </div>
                <div class="flex justify-between items-center text-[10px] text-slate-500 font-bold uppercase tracking-wider mt-4">
                    <span>Sep 01</span>
                    <span>Sep 10</span>
                    <span>Sep 20</span>
                    <span>Sep 30</span>
                </div>
            </div>

            <!-- Sidebar Area -->
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-[#131a2b] p-8 rounded-2xl border border-slate-700/30 shadow-xl h-full flex flex-col">
                    <h4 class="font-bold text-lg mb-6">Top Performing Mods</h4>
                    
                    <div class="space-y-6 flex-1">
                        @foreach (var mod in _topMods)
                        {
                            <div class="flex items-center gap-4">
                                <div class="h-11 w-11 bg-slate-800 rounded-xl flex items-center justify-center flex-shrink-0">
                                     <span class="material-symbols-outlined text-primary">extension</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-bold text-sm truncate">@mod.Name</h5>
                                    <p class="text-[10px] text-slate-500 uppercase font-bold tracking-tight">v1.2.0</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold">@((mod.Downloads / 1000.0).ToString("N1"))k</p>
                                    <p class="text-[10px] text-emerald-500 font-bold">+12%</p>
                                </div>
                            </div>
                        }
                    </div>

                    <button class="w-full mt-10 py-3 rounded-xl border border-slate-700 text-xs font-bold hover:bg-slate-800 transition-all">
                        View All Mods
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom section: Monetization -->
        <div class="bg-[#131a2b] p-20 rounded-3xl border border-slate-700/30 shadow-2xl relative overflow-hidden flex flex-col items-center text-center">
            <!-- Background gradients for glass effect -->
            <div class="absolute -top-1/2 -left-1/4 w-full h-full bg-primary/5 blur-[120px] rounded-full"></div>
            <div class="absolute -bottom-1/2 -right-1/4 w-full h-full bg-indigo-500/5 blur-[120px] rounded-full"></div>

            <div class="relative z-10 flex flex-col items-center">
                <span class="bg-primary/20 text-primary px-5 py-1.5 rounded-full text-xs font-extrabold uppercase tracking-widest mb-8 border border-primary/20">Coming Soon</span>
                <h2 class="text-4xl md:text-5xl font-bold mb-6 tracking-tight">Monetization is on its way</h2>
                <p class="text-slate-400 text-lg max-w-2xl leading-relaxed">
                    We're building the infrastructure to help you earn from your hard work. 
                    Stay tuned for Tips, Ad Revenue sharing, and more.
                </p>
            </div>
        </div>
    }
</div>
</div>

@code {
    private AnalyticsSummary? _summary;
    private List<Mod> _topMods = new();
    private List<ChartMetric> _chartMetrics = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        var handle = authState.User.FindFirst("github_handle")?.Value;

        if (string.IsNullOrEmpty(handle))
        {
            Nav.NavigateTo("/");
            return;
        }

        var devId = await ApiKeyService.GetDeveloperIdByHandle(handle);
        if (devId == null) return;

        // Seed data for demo
        await AnalyticsService.SeedDemoData(devId.Value);

        _summary = await AnalyticsService.GetSummary(devId.Value);
        _topMods = await AnalyticsService.GetTopPerformingMods(devId.Value);
        
        var history = await AnalyticsService.GetHistoricalMetrics(devId.Value, 20);
        
        // Group by date for chart
        var grouped = history.GroupBy(h => h.Date).OrderBy(g => g.Key).ToList();
        
        if (grouped.Any())
        {
            var maxViews = grouped.Max(g => g.Sum(x => x.Views));
            var maxDownloads = grouped.Max(g => g.Sum(x => x.Downloads));
            var maxValue = Math.Max(maxViews, maxDownloads);

            _chartMetrics = grouped.Select(g => new ChartMetric
            {
                Date = g.Key,
                ViewsHeight = (int)(g.Sum(x => x.Views) * 100.0 / maxValue),
                DownloadsHeight = (int)(g.Sum(x => x.Downloads) * 100.0 / maxValue)
            }).ToList();
        }
    }

    private class ChartMetric
    {
        public DateTime Date { get; set; }
        public int ViewsHeight { get; set; }
        public int DownloadsHeight { get; set; }
    }
}
